
@{
    ViewBag.Title = "RersonalProblemIndex";
}
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>个人问题列表</title>
    <style>
        body {
            padding: 32px; /*overflow-y: scroll;*/
        }

        .layui-select-disabled .layui-disabled {
            color: #000000 !important;
        }
    </style>
</head>
<body>
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
        <legend>个人问题列表</legend>
    </fieldset>
    <form class="layui-form layui-form-pane" action="">
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">系统类别</label>
                <div class="layui-input-inline">
                    <select ID="SystemCategory" name="SystemCategory" lay-filter="SystemCategory">
                        <option value=""></option>
                        <option value="IT(资讯类)">IT(资讯类)</option>
                        <option value="Logistics(总务后勤类)">
                            Logistics(总务后勤类)
                        </option>
                    </select>
                </div>
            </div>
            <div class="layui-inline">
                <div class="layui-inline">
                    <label class="layui-form-label">执行状态</label>
                    <div class="layui-input-inline">
                        <div id="statusSelect"> </div>
                    </div>
                </div>
                <div class="layui-inline" id="test6">
                    <label class="layui-form-label">填表月份</label>
                    <div class="layui-input-inline" style="width:20%">
                        @*<input type="text" class="layui-input" id="startDate">*@
                        <select id="queryYear" lay-filter="queryYear"></select>
                    </div>
                    <div class="layui-form-mid">年</div>
                    <div class="layui-input-inline">
                        <div id="monthsSelect"></div>
                    </div>

                    <div class="layui-form-mid">月</div>
                </div>
            </div>
        </div>
    </form>
    <div class="layui-btn-group" style="margin-left:1250px">
        <button class="layui-btn layui-btn-sm" id="btn_search"><i class="layui-icon">查询&nbsp;&#xe615;</i></button>
        <button class="layui-btn layui-btn-sm" id="btn_export"><i class="layui-icon">导出&nbsp;&#xe67d;</i></button>
    </div>
    <table class="layui-hide" lay-filter="user" id="RersonalProblemTable"></table>

</body>
<script type="text/html" id="ID-table-demo-css-user">
    <ul>
        <li><strong style="font-weight:400">【SystemCategory系统类别】: {{= d.SystemCategory }}</strong> </li>
        <li><strong style="font-weight:400">【Building大楼别】:{{= d.Building }}</strong> </li>
        <li><strong style="font-weight:400">【Loaction位置】:{{= d.Loaction }}</strong> </li>
    </ul>
</script>
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs" onclick=queryDetail('{{d.RepairId}}')>查看</a>
    @*<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>*@
</script>
<script>

    function queryDetail(RepairId) {
        //原窗口打开新页面
        var url = "@(Url.Action("RepairDetailVw", "Repair"))" + "?" + RepairId;;
        $("#content").load(url);
    }
       
    layui.use(['table', 'dropdown', 'form', 'laydate'], function () {
        var loading = layer.msg('页面加载中......');
        var $ = layui.$;
        var table = layui.table;
        var form = layui.form;
        var laydate = layui.laydate;
        var download = layui.download;

        loadOption();

        //墨绿主题
        laydate.render({
            elem: '#startDate'
            , theme: 'molv'
        });

        laydate.render({
            elem: '#endDate'
            , theme: 'molv'
        });

        render();

        $.ajax({
            url: "@(Url.Action("getRersonalProblemList", "Repair"))",  // 要提交的URL路径
            type: "post",    // 发送请求的方式
            dataType: "JSON",     // 指定传输的数据格式
            beforeSend: function () {     //请求之前的方法
            },
            success: function (result) {
                if (result.IsSuccess) {
                    let d = result;
                    layui.use(['form', 'jquery', 'table', 'layer'], function () {
                        var form = layui.form;
                        var $ = layui.jquery;
                        var table = layui.table;
                        var layer = layui.layer;

                        table.render({
                            elem: '#RersonalProblemTable',
                            type: "post",
                            data: d.data,
                            id: "RersonalProblemTableID",
                            toolbar: '#user',
                            contentType: 'application/json', // 参数为 json 格式传递
                            page: !0 || { //详细参数可参考 laypage 组件文档
                                curr: 5,
                                groups: 1,
                                first: false,
                                last: false,
                                layout: ['limit', 'prev', 'page', 'next', 'count'] //自定义分页布局
                            }
                            , height: 670
                            , cellMinWidth: 80
                            //,skin: 'line'
                            //,size: 'lg'
                            , toolbar: true
                           // ,height: 'full-35',
                            , lineStyle: 'height: 70px;line-height: 18px;', // 定义表格的多行样式
                            css: [ // 直接给当前表格主容器重置 css 样式
                                '.layui-table-page{text-align: center;}' // 让分页栏居中
                            ].join('')
                            , cols: [[
                                // { type: 'checkbox', LAY_CHECKED: false},
                                { fixed: 'left', title: '操作', width: '5%', minWidth: 80, toolbar: '#barDemo' },
                                { field: 'RepairId', width: '10%', title: '请修编号' },
                                { field: 'username', width: '18%', title: '分类项目', templet: '#ID-table-demo-css-user' },
                                //{ field: 'SystemCategory', title: 'SystemCategory(系统类别)', width: 210 },
                                //{ field: 'Building', title: 'Building(大楼别)', width: 210 },
                                //{ field: 'Loaction', title: 'Loaction(位置)', width: 210 },
                                { field: 'Category', title: '类别', width: '10%' },
                                { field: 'ChargeEmpname', title: '负责人姓名', width: '10%' },
                                { field: 'ResponseContent', title: '反应内容', width: '15%', style: 'color:#020615' },
                                { field: 'Status', title: '执行状态', width: '10%' },
                                {
                                    field: 'CreatTime', title: '填表时间', width: '11%',
                                    templet: "<div>{{ formatDate(d.CreatTime,'yyyy-MM-dd HH:mm:ss')}}</div>"
                                },
                                {
                                    field: 'FinishTime', title: '完单时间', width: '11%',
                                    templet: "<div>{{ formatDate(d.FinishTime,'yyyy-MM-dd HH:mm:ss')}}</div>"
                                }
                            ]],
                            done: function () {
                                layer.close(loading);
                            }
                        });
                    });
                } else {
                    alert(result.Msg);
                }
            },
            error: function () {
                // 请求失败后要执行的代码
                console.log("失败");
                alert(result.Msg);
            }
        });

        function reloadDate() {
            var model = {
                SystemCategory: $('#SystemCategory').val(),
                KindCategory: $('#KindCategory').val(),
                Status: statusString.getValue('valueStr'),
                queryYear: $('#queryYear').val(),
                queryMonths: monthsString.getValue('valueStr')
            }
            $.ajax({
                url: "@(Url.Action("getRersonalProblemList", "Repair"))",   // 要提交的URL路径
                type: "post",    // 发送请求的方式
                data: model,
                dataType: "JSON",     // 指定传输的数据格式
                success: function (result) {
                    if (result.IsSuccess) {
                        let d = result;
                        table.reload('RersonalProblemTableID', {
                        data: d.data,
                        page: { curr: 1 },
                        });
                    } else {
                        alert(result.Msg);
                    }
                },
                error: function () {
                    // 请求失败后要执行的代码
                    console.log("失败");
                    alert(result.Msg);
                }
            });
        }

        let monthsString = {};
        monthsString = xmSelect.render({
            el: '#monthsSelect',
            name: 'months',
            // layVerify: 'required',
            max: 12,     // 最多选择 3 个
            data: [
                { name: '1', value: 1 },
                { name: '2', value: 2 },
                { name: '3', value: 3 },
                { name: '4', value: 4 },
                { name: '5', value: 5 },
                { name: '6', value: 6 },
                { name: '7', value: 7 },
                { name: '8', value: 8 },
                { name: '9', value: 9 },
                { name: '10', value: 10 },
                { name: '11', value: 11 },
                { name: '12', value: 12 }
            ]
        });


        function loadOption() {

            var myDate = new Date();
            var startYear = myDate.getFullYear() -5;//起始年份
            var endYear = myDate.getFullYear();//结束年份
            for (var i = startYear; i <= endYear; i++) {
                $("#queryYear").append("<option value='" + i + "'>" + i + "</option>");
            }
            $("#queryYear").val(myDate.getFullYear());
            form.render();

            var data = [];
           // $("#OpStatus").empty();
            $.ajax({
                url: "@(Url.Action("getStatusEvery", "DDL"))",
                type: "POST",
                dataType: 'json',
                success: function (result) {
                  //  $('#OpStatus').append(new Option());
                    for (let i = 0, len = result.length; i < len; i++) {
                       // $("#OpStatus").append(`<option value="${result[i].StatusValue}">${result[i].StatusText}</option>`);
                        data.push({
                            name: result[i]['StatusText'],
                            value: result[i]['StatusValue']
                        });  
                    }
                    statusString = xmSelect.render({
                        el: '#statusSelect',
                        name: 'status',
                        // layVerify: 'required',
                        max: 12,     // 最多选择 3 个
                        data: data
                    });
                },
                error: function (error) {
                    console.log(error)
                }
            });

            @*$("#Status").empty();
            $.ajax({
                url: "@(Url.Action("getStatusEvery", "DDL"))",
                type: "POST",
                dataType: 'json',
                success: function (result) {
                    $('#Status').append(new Option());
                    for (let i = 0, len = result.length; i < len; i++) {
                        $("#Status").append(`<option value="${result[i].StatusValue}">${result[i].StatusText}</option>`);
                    }
                    layui.use('form', function () {
                        var form = layui.form;
                        form.render();
                    });
                },
                error: function (error) {
                    console.log(error)
                }
            });*@

        }

        form.on('select(SystemCategory)', function (data) {
            $("#Status").empty();
            var SystemCategory = data.value;
            if (SystemCategory == null || SystemCategory == "") {
                loadOption();
            } else {
                $.ajax({
                    type: "post",
                     url: "@(Url.Action("getStatusEvery", "DDL"))",
                    data: { "keyWord": SystemCategory },
                    dataType: "json",
                    success: function (result) {
                        $('#Status').append(new Option());
                    for (let i = 0, len = result.length; i < len; i++) {
                        $("#Status").append(`<option value="${result[i].StatusValue}">${result[i].StatusText}</option>`);
                    }
                        form.render();
                    }, error: function () {
                        layer.alert('请求失败');
                    }
                });
            }
        })

        $('#btn_search').click(function () {
            reloadDate();
        });

        function request() {
            var model = {
                SystemCategory: $('#SystemCategory').val(),
                KindCategory: $('#KindCategory').val(),
                Status: statusString.getValue('valueStr'),
                queryYear: $('#queryYear').val(),
                queryMonths: monthsString.getValue('valueStr')
            };

            fetch("@(Url.Action("RersonalProblemExport", "Repair"))", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(model),
            })
                .then(res => res.blob())
                .then(data => {
                    if (data.size == 0) {
                        layui.use('layer', function () {
                            var layer = layui.layer;
                            layer.msg("下载失败！");
                        });
                    } else {
                        let blobUrl = window.URL.createObjectURL(data);
                       // window.location = blobUrl;
                        const a = document.createElement('a');
                        var datetime = layui.util.toDateString(new Date().getTime(), "yyyyMMddHHmmss");
                        console.log(datetime);
                        a.download = "RersonalProblem_" + datetime + ".xlsx";
                        a.href = blobUrl;
                        a.click();
                        //download(blobUrl);
                    }
                });
        }

        $('#btn_export').click(function () {
            request();
        });


        //$('#queryDetail').click(function (data) {
           
        //});

        //触发单元格工具事件
        table.on('tool(user)', function (obj) { // 双击 toolDouble
            var data = obj.data;
            alert("222");
            ////console.log(obj)
            //if (obj.event === 'del') {
            //    layer.confirm('真的删除行么', function (index) {
            //        obj.del();
            //        layer.close(index);
            //    });
            //} else if (obj.event === 'edit') {
            //    layer.open({
            //        title: '编辑',
            //        type: 1,
            //        area: ['80%', '80%'],
            //        content: '<div style="padding: 16px;">自定义表单元素</div>'
            //    });
            //}
        });

        function download(blobUrl) {
            const a = document.createElement('a');
            a.download = 'a.xsls';
            a.href = blobUrl;
            a.click();
        }

        function render() {
            // 封装函数-表单更新渲染
            layui.use('form', function () {
                var form = layui.form;
                form.render('select');
            })
        }

    });
</script>

