
@{
    ViewBag.Title = "RepairDetailVw";
}
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>报修单详情</title>
    <style>
        body {
            padding: 32px; /*overflow-y: scroll;*/
        }

        .layui-select-disabled .layui-disabled {
            color: #000000 !important;
        }

        .layui-form-select dl {
            max-height: 1000%;
            max-width: 60%;
        }

            .layui-form-select dl dd, .layui-form-select dl dt {
                white-space: pre-wrap;
                overflow: visible;
                text-overflow: ellipsis;
            }
    </style>
</head>
<body>
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
        <legend>Repair Problem Details 报修单详情</legend>
    </fieldset>
    <br />
    <hr />
    <div id="fillQuestion">
        <table width="70%" align="center" border="2">
            <tr height="30px">
                <td align="right" width="35%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">ID(请修编号)：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="RepairId"></label> </td>
            </tr>
            <tr height="30px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">SystemCategory(系统类别)：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="SystemCategory"></label> </td>
            </tr>
            <tr height="30px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">Building(大楼别)：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="Building"></label> </td>
            </tr>
            <tr height="30px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">Loaction(位置)：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="Loaction"></label> </td>
            </tr>
            <tr height="30px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">RoomNum(空间编号)：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="RoomNum"></label> </td>
            </tr>
            <tr height="30px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">Repairer(负责人)：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="ChargeEmpname"></label> </td>
            </tr>
            <tr height="30px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">Contacts(反应人)：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="ResponseEmpname"></label> </td>
            </tr>
            <tr height="30px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">Tel-Ext(联络分机)：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="Telephone"></label> </td>
            </tr>
            <tr height="100px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">repair time(维护时间)：</label></td>
                <td width="60%">
                    <div class="layui-input-inline">
                        <textarea id="RepairTime" style="font-size:large;width:300%;height:80px" readonly />
                    </div>
                </td>
            </tr>
            <tr height="30px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">Category(类别)：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="Category"></label> </td>
            </tr>
            <tr height="30px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">Damage Reason(损坏原因)：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="DamageReason"></label> </td>
            </tr>
            <tr height="30px" id="DamageText1" hidden="hidden">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">Class/Unit(班级/单位)：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="DamageClass"></label> </td>
            </tr>
            <tr height="30px" id="DamageText2" hidden="hidden">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">Name(姓名)：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="DamageName"></label> </td>
            </tr>
            <tr height="30px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">Fill-in Date(填表时间)：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="CreatTime"></label> </td>
            </tr>
            <tr height="200px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">Description(反应内容)：</label></td>
                <td width="60%">
                    <div class="layui-input-inline">
                        <textarea id="ResponseContent" style="font-size:large;width:300%;height:170px" readonly />
                    </div>
                    <div id="imgId">
                    </div>
                </td>
            </tr>
            <tr height="200px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">ReplyContent(过去回应内容)：</label></td>
                <td width="60%">
                    <div class="layui-input-inline">
                        <textarea id="ReplyContent" style="font-size:large;width:300%;height:170px" readonly />
                    </div>
                    <div id="imgId2">
                    </div>
                </td>
            </tr>
            <tr>
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">Status(执行状态)：</label></td>
                <td width="60%">
                    <div class="layui-form layui-form-pane" style="margin-left:20px">
                        <div class="layui-input-inline">
                            <select ID="OpStatus" name="OpStatus" disabled="disabled">
                                <option value=""></option>
                            </select>
                        </div>
                    </div>
                </td>
            </tr>
            <tr height="30px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">Finish Time(完单时间)：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="FinishTime"></label> </td>
            </tr>
        </table>
    </div>
    <br /><br /><br />
    <div class="layui-form-item">
        <div class="layui-input-block" style="margin-left:50%">
            <button type="button" id="btn_back" class="layui-btn">返回 Back</button>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label"></label>
        <div class="layui-input-block">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label"></label>
        <div class="layui-input-block">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label"></label>
    </div>
</body>
<script>

    function queryDetailVw(RepairId) {
        var loading = layer.msg('页面加载中......');
         $.ajax({
             url: "@(Url.Action("getRepairDetail", "Repair"))",   // 要提交的URL路径
             type: "post",    // 发送请求的方式
             data: { RepairId: RepairId },
                dataType: "JSON",     // 指定传输的数据格式
             success: function (res) {
                 //取到的数据存储到localStorage
                 localStorage.clear();
                 localStorage.setItem("RepairId", res.RepairId);
                 localStorage.setItem("Stu_Name", res.Stu_Name);
                 localStorage.setItem("SystemCategory", res.SystemCategory);
                 localStorage.setItem("Building", res.Building);
                 localStorage.setItem("Loaction", res.Loaction);
                 localStorage.setItem("ChargeEmpno", res.ChargeEmpno);
                 localStorage.setItem("ChargeEmpname", res.ChargeEmpname);
                 localStorage.setItem("Category", res.Category);
                 localStorage.setItem("ResponseContent", res.ResponseContent);
                 localStorage.setItem("ResponseEmpname", res.ResponseEmpname);
                 localStorage.setItem("ReplyContent", res.ReplyContent);
                 localStorage.setItem("Status", res.Status);
                 localStorage.setItem("CreatTime", res.CreatTime);
                 localStorage.setItem("FinishTime", res.FinishTime);
                 localStorage.setItem("PhotoPath", res.PhotoPath);
                 localStorage.setItem("RoomNum", res.RoomNum);
                 localStorage.setItem("RepairTime", res.RepairTime);
                 localStorage.setItem("Telephone", res.Telephone);
                 localStorage.setItem("DamageReason", res.DamageReason);
                 localStorage.setItem("DamageClass", res.DamageClass);
                 localStorage.setItem("DamageName", res.DamageName);
                 localStorage.setItem("ReplyPhoto", res.ReplyPhoto);

                 $("#RepairId").html(localStorage.getItem("RepairId"));
                 $("#ResponseContent").html(localStorage.getItem("ResponseContent") == "null" ? '' : localStorage.getItem("ResponseContent"));
                 $("#SystemCategory").html(localStorage.getItem("SystemCategory"));
                 $("#Building").html(localStorage.getItem("Building"));
                 $("#Loaction").html(localStorage.getItem("Loaction"));
                 $("#ChargeEmpname").html(localStorage.getItem("ChargeEmpname"));
                 $("#RoomNum").html(localStorage.getItem("RoomNum"));
                 $("#ResponseEmpname").html(localStorage.getItem("ResponseEmpname"));
                 $("#Telephone").html(localStorage.getItem("Telephone"));
                 $("#RepairTime").html(localStorage.getItem("RepairTime") == "null" ? '' : localStorage.getItem("RepairTime"));
                 $("#Category").html(localStorage.getItem("Category"));
                 $("#DamageReason").html(localStorage.getItem("DamageReason"));
                 $("#DamageClass").html(localStorage.getItem("DamageClass"));
                 $("#DamageName").html(localStorage.getItem("DamageName"));
                 $("#CreatTime").html(formatDate(localStorage.getItem("CreatTime"), 'yyyy-MM-dd HH:mm:ss'));
                 $("#ReplyContent").html(localStorage.getItem("ReplyContent") == "null" ? '' : localStorage.getItem("ReplyContent"));
                 $("#FinishTime").html(localStorage.getItem("FinishTime") == "null" ? '' : formatDate(localStorage.getItem("CreatTime"), 'yyyy-MM-dd HH:mm:ss')); 
                 layer.close(loading);
                 //console.log(localStorage);
             },
             error: function () {
                 // 请求失败后要执行的代码
                 console.log("失败");
                 alert(res.Msg);
             }
         });
    }

    function loadImg() {

        //遍历图片 PhotoPath
        if (localStorage.getItem("PhotoPath") != null && localStorage.getItem("PhotoPath") != '' && localStorage.getItem("PhotoPath") != 'null') {
          //  var root = window.location.pathname == "/" ? '' : window.location.pathname;//兼容本地测试
            var PhotoPathS = localStorage.getItem("PhotoPath");
            PhotoPathS = PhotoPathS.substring(0, PhotoPathS.length - 1);
            var files = PhotoPathS.split(";");
            var imgId = document.getElementById("imgId");
           // var url = root;
            for (var i = 0; i < files.length; i++) {
                var name = files[i];
                var img = document.createElement("img");
                img.style = "width:120px;height:120px;";
                img.className = "imgview";
                img.src = "../"+ name;
                imgId.appendChild(img);
            }
        }

        if (localStorage.getItem("ReplyPhoto") != null && localStorage.getItem("ReplyPhoto") != '' && localStorage.getItem("ReplyPhoto") != 'null') {
            // var root = window.location.pathname == "/" ? '' : window.location.pathname;//兼容本地测试
            var ReplyPhotoS = localStorage.getItem("ReplyPhoto");
            ReplyPhotoS = ReplyPhotoS.substring(0, ReplyPhotoS.length - 1);
            var files2 = ReplyPhotoS.split(";");
            var imgId2 = document.getElementById("imgId2");
            // var url = root;
            for (var i = 0; i < files2.length; i++) {
                var name2 = files2[i];
                var img2 = document.createElement("img");
                img2.style = "width:120px;height:120px;";
                img2.className = "imgview";
                img2.src = "../" + name2;
                imgId2.appendChild(img2);
            }
        }
    }
    
    layui.use(['upload', 'element', 'layer', 'laydate','form'], function () {
        var form = layui.form;
        var layer = layui.layer;
        var util = layui.util;
        var laydate = layui.laydate;

        loadOption();

        loadImg();

        var newURL = '@(Session["URL"])';
        var dd = newURL.split('?');
        var dd1 = dd[1];
        queryDetailVw(dd1);

       

        $("body").on("click", ".imgview", function (e) {
            layer.photos({ photos: { "data": [{ "src": e.target.src }] } });
        });

        function loadOption() {     
            $("#OpStatus").empty();
            var SystemCategory = localStorage.getItem("SystemCategory");
            if (SystemCategory == null || SystemCategory == "") {
                loadOption();
            } else {
                $.ajax({
                    type: "post",
                     url: "@(Url.Action("getStatusEvery", "DDL"))",
                    data: { "keyWord": SystemCategory },
                    dataType: "json",
                    success: function (result) {
                        $('#OpStatus').append(new Option());
                        for (let i = 0, len = result.length; i < len; i++)
                        {
                            $("#OpStatus").append(`<option value="${result[i].StatusValue}">${result[i].StatusText}</option>`);
                        }
                        $('select[name=OpStatus]').val(localStorage.getItem("Status"));
                        form.render();
                    }, error: function () {
                        layer.alert('请求失败');
                    }
                });
            }
        }

        //隐藏div
        $("#DamageText1").hide();
        $("#DamageText2").hide();

        if (localStorage.getItem("DamageReason") =="natural cause(自然)") {
            $("#DamageText1").hide();
            $("#DamageTex2").hide();
        } else{
            $("#DamageText1").show();
            $("#DamageText2").show();
        }
        
        
       // localStorage.clear();
        
         $("#btn_back").on("click", function () {
             var url = "@(Url.Action("RersonalProblemIndex", "Repair"))";
             var sId2 = window.location.href;
             var dd = sId2.split('?');
             var dd1 = dd[0];
             history.replaceState(null, null, dd1);
             $("#content").load(url);
        });
    });
</script>

