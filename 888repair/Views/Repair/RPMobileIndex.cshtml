
@{
    ViewBag.Title = "RPMobileIndex";
}
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>个人问题列表</title>
    <style>
        body {
            padding: 32px; /*overflow-y: scroll;*/
        }

        .layui-select-disabled .layui-disabled {
            color: #000000 !important;
        }
    </style>
</head>
<body>
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
        <legend>个人问题列表</legend>
    </fieldset>
    @*<table lay-filter="user" id="RersonalProblemTable"></table>*@
    <table class="layui-hide" id="ID-table-demo-css"></table>
    <div class="layui-form-item">
        <label class="layui-form-label"></label>
        <div class="layui-input-block">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label"></label>
        <div class="layui-input-block">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label"></label>
    </div>
</body>
<script type="text/html" id="ID-table-demo-css-user">
    <a onclick=queryDetail('{{d.RepairId}}')>   
        <ul>   
            <li><strong style="color:#48b2c8;font-size:large">【ID请修编号】 {{= d.RepairId }}</strong> </li> 
            <li><strong style="font-size:smaller">【System Category 系统类别】: {{= d.SystemCategory }}</strong> </li>   
            <li><strong style="font-size:smaller">【Building 大楼别】:{{= d.Building }}</strong> </li>    
            <li><strong style="font-size:smaller">【Loaction 位置】:{{= d.Loaction }}</strong> </li> 
            <li><strong style="font-size:smaller">【Repairer 负责人】:{{= d.ChargeEmpname }}</strong> </li> 
            <li><strong style="font-size:smaller;white-space:nowrap;text-overflow:ellipsis;overflow:hidden">【Description 反应内容】:{{= d.ResponseContent }}</strong> </li>   
            <li class="layui-icon">       
                &#xe637;<span style="font-size:smaller">{{ formatDate(d.CreatTime,'yyyy-MM-dd HH:mm:ss')}}</span>        
                <span style="font-size:smaller;color:#48b2c8;padding-left:20%">{{= d.Status }}</span>
            </li>
        </ul>
    </a>
</script>
<script>

     function queryDetail(RepairId) {
         $.ajax({
             url: "@(Url.Action("getRepairDetail", "Repair"))",   // 要提交的URL路径
             type: "post",    // 发送请求的方式
             data: { RepairId: RepairId },
                dataType: "JSON",     // 指定传输的数据格式
             success: function (res) {
                 //取到的数据存储到localStorage
                 localStorage.clear();
                 localStorage.setItem("RepairId", res.RepairId);
                 localStorage.setItem("Stu_Name", res.Stu_Name);
                 localStorage.setItem("SystemCategory", res.SystemCategory);
                 localStorage.setItem("Building", res.Building);
                 localStorage.setItem("Loaction", res.Loaction);
                 localStorage.setItem("ChargeEmpno", res.ChargeEmpno);
                 localStorage.setItem("ChargeEmpname", res.ChargeEmpname);
                 localStorage.setItem("Category", res.Category);
                 localStorage.setItem("ResponseContent", res.ResponseContent);
                 localStorage.setItem("ResponseEmpname", res.ResponseEmpname);
                 localStorage.setItem("ReplyContent", res.ReplyContent);
                 localStorage.setItem("Status", res.Status);
                 localStorage.setItem("CreatTime", res.CreatTime);
                 localStorage.setItem("FinishTime", res.FinishTime);
                 localStorage.setItem("PhotoPath", res.PhotoPath);
                 localStorage.setItem("RoomNum", res.RoomNum);
                 localStorage.setItem("RepairTime", res.RepairTime);
                 localStorage.setItem("Telephone", res.Telephone);
                 localStorage.setItem("DamageReason", res.DamageReason);
                 localStorage.setItem("DamageClass", res.DamageClass);
                 localStorage.setItem("DamageName", res.DamageName);
                 //原窗口打开新页面
                 var url = "@(Url.Action("RepairDetailMobileVw", "Repair"))" + "?RepairId=" + RepairId;;
                 $("#content").load(url);
             },
             error: function () {
                 // 请求失败后要执行的代码
                 console.log("失败");
                 alert(res.Msg);
             }
         });
     }

    layui.use(['table', 'dropdown', 'form', 'laydate'], function () {

        var $ = layui.$;
        var table = layui.table;
        var form = layui.form;
        var laydate = layui.laydate;
        var download = layui.download;
        var page = layui.laypage;

        loadOption();

        //墨绿主题
        laydate.render({
            elem: '#startDate'
            , theme: 'molv'
        });

        laydate.render({
            elem: '#endDate'
            , theme: 'molv'
        });

        render();

        // 创建渲染实例
        $.ajax({
            url: "@(Url.Action("getRersonalProblemList", "Repair"))",  // 要提交的URL路径
            type: "post",    // 发送请求的方式
            dataType: "JSON",     // 指定传输的数据格式
            beforeSend: function () {     //请求之前的方法
            },
            success: function (result) {
                if (result.IsSuccess) {
                    let d = result;
                    layui.use(['form', 'jquery', 'table', 'layer'], function () {
                        var table = layui.table;
                        table.render({
                            elem: '#ID-table-demo-css',
                            type: "post",
                            data: d.data,
                            id: "RersonalProblemTableID",
                           // toolbar: '#user',
                            contentType: 'application/json', // 参数为 json 格式传递
                            page: true, //是否显示分页
                            limits: [3, 5, 10],
                            limit: 3, //每页默认显示的数量
                            //done: function (res) {
                            //    userPage.data = res.data;
                            //},
                            height: 550,
                            lineStyle: 'height: 251px;', // 定义表格的多行样式
                            css: [ // 直接给当前表格主容器重置 css 样式
                                '.layui-table-page{text-align: center;}' // 让分页栏居中
                            ].join(''),
                            className: 'layui-table-testcss', // 用于给表格主容器追加 css 类名
                            cols: [[
                                { field: 'username', width: 357, templet: '#ID-table-demo-css-user' },

                            ]]
                        });
                    });
                } else {
                    alert(result.Msg);
                }
            },
            error: function () {
                // 请求失败后要执行的代码
                console.log("失败");
                alert(result.Msg);
            }
        });
       
        function reloadDate() {
            var model = {
                SystemCategory: $('#SystemCategory').val(),
                KindCategory: $('#KindCategory').val(),
                startDate: $('#startDate').val(),
                endDate: $('#endDate').val(),
                Status: $('#Status').val(),
            }
            $.ajax({
                url: "@(Url.Action("getRersonalProblemList", "Repair"))",   // 要提交的URL路径
                type: "post",    // 发送请求的方式
                data: model,
                dataType: "JSON",     // 指定传输的数据格式
                success: function (result) {
                    if (result.IsSuccess) {
                        let d = result;
                        table.reload('RersonalProblemTableID', {
                        data: d.data,
                        page: { curr: 1 },
                        });
                    } else {
                        alert(result.Msg);
                    }
                },
                error: function () {
                    // 请求失败后要执行的代码
                    console.log("失败");
                    alert(result.Msg);
                }
            });
        }

        function loadOption() {
            $("#Status").empty();
            $.ajax({
                url: "@(Url.Action("getStatusEvery", "DDL"))",
                type: "POST",
                dataType: 'json',
                success: function (result) {
                    $('#Status').append(new Option());
                    for (let i = 0, len = result.length; i < len; i++) {
                        $("#Status").append(`<option value="${result[i].StatusValue}">${result[i].StatusText}</option>`);
                    }
                    layui.use('form', function () {
                        var form = layui.form;
                        form.render();
                    });
                },
                error: function (error) {
                    console.log(error)
                }
            });

        }

        form.on('select(SystemCategory)', function (data) {
            $("#Status").empty();
            var SystemCategory = data.value;
            if (SystemCategory == null || SystemCategory == "") {
                loadOption();
            } else {
                $.ajax({
                    type: "post",
                     url: "@(Url.Action("getStatusEvery", "DDL"))",
                    data: { "keyWord": SystemCategory },
                    dataType: "json",
                    success: function (result) {
                        $('#Status').append(new Option());
                    for (let i = 0, len = result.length; i < len; i++) {
                        $("#Status").append(`<option value="${result[i].StatusValue}">${result[i].StatusText}</option>`);
                    }
                        form.render();
                    }, error: function () {
                        layer.alert('请求失败');
                    }
                });
            }
        })

        $('#btn_search').click(function () {
            reloadDate();
        });
        
        function render() {
            // 封装函数-表单更新渲染
            layui.use('form', function () {
                var form = layui.form;
                form.render('select');
            })
        }

    });
</script>

