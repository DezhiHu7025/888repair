
@{
    ViewBag.Title = "ProblemAllDetailVw";
}
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>问题列表维护</title>
    <style>
        body {
            padding: 32px; /*overflow-y: scroll;*/
        }

        .layui-select-disabled .layui-disabled {
            color: #000000 !important;
        }

        .layui-form-select dl {
            max-height: 1000%;
            max-width: 60%;
        }

            .layui-form-select dl dd, .layui-form-select dl dt {
                white-space: pre-wrap;
                overflow: visible;
                text-overflow: ellipsis;
            }
    </style>
</head>
<body>
    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
        <legend>问题列表维护</legend>
    </fieldset>
    <br />
    <hr />
    <form class="layui-form" id="fillQuestion">
        <table width="70%" align="center" border="2">
            <tr height="30px">
                <td align="right" width="35%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">请修编号：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="RepairId"></label> </td>
            </tr>
            <tr height="30px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">系统类别：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="SystemCategory"></label> </td>
            </tr>
            <tr height="30px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">大楼别：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="Building"></label> </td>
            </tr>
            <tr height="30px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">位置：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="Loaction"></label> </td>
            </tr>
            <tr height="30px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">空间编号：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="RoomNum"></label> </td>
            </tr>
            <tr height="30px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">负责人：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="ChargeEmpname"></label> </td>
            </tr>
            <tr height="30px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">反应人：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="ResponseEmpname"></label> </td>
            </tr>
            <tr height="30px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">联络分机：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="Telephone"></label> </td>
            </tr>
            <tr height="100px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">维护时间：</label></td>
                <td width="60%">
                    <div class="layui-input-inline">
                        <textarea id="RepairTime" style="font-size:large;width:300%;height:80px" readonly />
                    </div>
                </td>
            </tr>
            <tr height="30px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">类别：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="Category"></label> </td>
            </tr>
            <tr height="30px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">损坏原因：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="DamageReason"></label> </td>
            </tr>
            <tr height="30px" id="DamageText1" hidden="hidden">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">班级/单位：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="DamageClass"></label> </td>
            </tr>
            <tr height="30px" id="DamageText2" hidden="hidden">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">姓名：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="DamageName"></label> </td>
            </tr>
            <tr height="30px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">填表时间：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="CreatTime"></label> </td>
            </tr>
            <tr height="200px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">反应内容：</label></td>
                <td width="60%">
                    <div class="layui-input-inline">
                        <textarea id="ResponseContent" style="font-size:large;width:300%;height:170px" readonly />
                    </div>
                    <div id="imgId">
                    </div>
                </td>
            </tr>
            <tr height="200px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:purple;">过去回应内容：</label></td>
                <td width="60%">
                    <div class="layui-input-inline">
                        <textarea id="ReplyContent" style="font-size:large;width:300%;height:170px" readonly />
                    </div>
                    <div id="imgId2">
                    </div>
                </td>
            </tr>
            <tr height="200px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="color:red">*</label>&nbsp;&nbsp;<label style="font-size:large;color:orangered;">新增回应内容：</label></td>
                <td width="60%">
                    <div class="layui-input-inline">
                        <textarea id="NewReplyContent" style="font-size:large;width:300%;height:170px" lay-verify="required" />
                    </div>
                </td>
            </tr>
            <tr>
                <td align="right" width="40%" style="background-color:lightgrey">
                    <label style="color:red">*</label>&nbsp;&nbsp;<label style="font-size:large;color:orangered;">执行状态：</label>
                </td>
                <td width="60%">
                    <br />
                    <div class="layui-form layui-form-pane" style="margin-left:20px">
                        <div class="layui-input-inline">
                            <select ID="OpStatus" name="OpStatus" lay-verify="required">
                                <option value=""></option>
                            </select>
                        </div>
                    </div>
                    <br />
                </td>
            </tr>
            <tr height="30px">
                <td align="right" width="40%" style="background-color:lightgrey"><label style="font-size:large;color:orangered;">完单时间：</label></td>
                <td width="60%"> <label style="font-size:large;margin-left:20px" id="FinishTime"></label> </td>
            </tr>
        </table>
        <br /><br />
        <div class="layui-form-item">
            <div class="layui-input-block" style="margin-left:45%">
                <button class="layui-btn" id="btn_submit" lay-submit lay-filter="demo1">送出</button>
                <button type="button" id="btn_back" class="layui-btn">返回</button>
            </div>
        </div>
    </form>

    <div class="layui-form-item">
        <label class="layui-form-label"></label>
        <div class="layui-input-block">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label"></label>
        <div class="layui-input-block">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label"></label>
    </div>
</body>

<div class="layui-form" style="display:none" id="rejectendWindow">
    <br /><br />
    <form class="layui-form-item">
        <div class="layui-inline">
            <label class="layui-form-label">驳回意见&nbsp;&nbsp;<label style="color:red">*</label></label>
            <div class="layui-input-inline">
                <textarea type="text" name="opinionend" id="opinionend" autocomplete="off" class="layui-input" style="height:100px;width:530px" lay-verify="required" />
            </div>
        </div>
        <button class="layui-layer-btn0" id="btn_rejectend" style="display:none" lay-submit lay-filter="demo4"></button>
    </form>
</div>
<script>

    function loadImg() {
        //遍历图片 PhotoPath
        if (localStorage.getItem("PhotoPath") != null && localStorage.getItem("PhotoPath") != '' && localStorage.getItem("PhotoPath") != 'null') {
          //  var root = window.location.pathname == "/" ? '' : window.location.pathname;//兼容本地测试
            var PhotoPathS = localStorage.getItem("PhotoPath");
            PhotoPathS = PhotoPathS.substring(0, PhotoPathS.length - 1);
            var files = PhotoPathS.split(";");
            var imgId = document.getElementById("imgId");
           // var url = root;
            for (var i = 0; i < files.length; i++) {
                var name = files[i];
                var img = document.createElement("img");
                img.style = "width:120px;height:120px;";
                img.className = "imgview";
                img.src = "../" + name;
                imgId.appendChild(img);
            }
        }

        if (localStorage.getItem("ReplyPhoto") != null && localStorage.getItem("ReplyPhoto") != '' && localStorage.getItem("ReplyPhoto") != 'null') {
            // var root = window.location.pathname == "/" ? '' : window.location.pathname;//兼容本地测试
            var ReplyPhotoS = localStorage.getItem("ReplyPhoto");
            ReplyPhotoS = ReplyPhotoS.substring(0, ReplyPhotoS.length - 1);
            var files2 = ReplyPhotoS.split(";");
            var imgId2 = document.getElementById("imgId2");
            // var url = root;
            for (var i = 0; i < files2.length; i++) {
                var name2 = files2[i];
                var img2 = document.createElement("img");
                img2.style = "width:120px;height:120px;";
                img2.className = "imgview";
                img2.src = "../" + name2;
                imgId2.appendChild(img2);
            }
        }
    }


    layui.use(['table', 'dropdown', 'form'], function () {
        var $ = layui.$;
        var table = layui.table;
        var form = layui.form;
        var layer = layui.layer;

        loadOption();

        loadImg();

        $("body").on("click", ".imgview", function (e) {
            layer.photos({ photos: { "data": [{ "src": e.target.src }] } });
        });

        function loadOption() {
            $("#OpStatus").empty();
            var SystemCategory = localStorage.getItem("SystemCategory");
            if (SystemCategory == null || SystemCategory == "") {
                loadOption();
            } else {
                $.ajax({
                    type: "post",
                     url: "@(Url.Action("getStatus", "DDL"))",
                    data: { "keyWord": SystemCategory },
                    dataType: "json",
                    success: function (result) {
                        $('#OpStatus').append(new Option());
                        for (let i = 0, len = result.length; i < len; i++)
                        {
                            if (result[i].StatusValue == "rejectend") {
                                $("#OpStatus").append(`<option value="${result[i].StatusValue}" disabled="">${result[i].StatusText}</option>`);
                            } else {
                                $("#OpStatus").append(`<option value="${result[i].StatusValue}">${result[i].StatusText}</option>`);
                            }
                        }
                        $('select[name=OpStatus]').val(localStorage.getItem("Status"));
                        form.render();
                    }, error: function () {
                        layer.alert('请求失败');
                    }
                });
            }

            $("#OpEmpNo").empty();
            var SystemCategory = localStorage.getItem("SystemCategory");
            if (SystemCategory == null || SystemCategory == "") {
                loadOption();
            } else {
                $.ajax({
                    type: "post",
                    url: "@(Url.Action("getChargePersonBySystemCategory", "DDL"))",
                    data: { "keyWord": SystemCategory },
                    dataType: "json",
                    success: function (result) {
                        $('#OpEmpNo').append(new Option());
                        for (let i = 0, len = result.length; i < len; i++)
                        {
                            if (result[i].FullName == localStorage.getItem("ChargeEmpname")) {
                                $("#OpEmpNo").append(`<option value="${result[i].EmpNo}" disabled="">${result[i].FullName}</option>`);
                            } else {
                                $("#OpEmpNo").append(`<option value="${result[i].EmpNo}">${result[i].FullName}</option>`);
                            }
                        }
                        form.render();
                    }, error: function () {
                        layer.alert('请求失败');
                    }
                });
            }
        }


        //隐藏div
        $("#DamageText1").hide();
        $("#DamageText2").hide();

        if (localStorage.getItem("DamageReason") =="natural cause(自然)") {
            $("#DamageText1").hide();
            $("#DamageTex2").hide();
        } else{
            $("#DamageText1").show();
            $("#DamageText2").show();
        }

        if (localStorage.getItem("Status") == "complete" || localStorage.getItem("Status") == "rejectend" ) {
            $('#OpStatus').addClass("layui-disabled").attr("disabled", "disabled");
            $('#TransferProblem').addClass("layui-disabled").attr("disabled", "disabled");
            $('#RejectTask').addClass("layui-disabled").attr("disabled", "disabled");
            $('#RejectEnd').addClass("layui-disabled").attr("disabled", "disabled");
            $('#btn_submit').addClass("layui-disabled").attr("disabled", "disabled");
            $('#NewReplyContent').addClass("layui-disabled").attr("readonly", "readonly");
        } else {
            $('#OpStatus').removeClass("layui-disabled").removeAttr("disabled", "disabled");
            $('#TransferProblem').removeClass("layui-disabled").removeAttr("disabled", "disabled");
            $('#RejectTask').removeClass("layui-disabled").removeAttr("disabled", "disabled");
            $('#RejectEnd').removeClass("layui-disabled").removeAttr("disabled", "disabled");
            $('#btn_submit').removeClass("layui-disabled").removeAttr("disabled", "disabled");
            $('#NewReplyContent').removeClass("layui-disabled").removeAttr("disabled", "disabled");
        }
        
        //当前用户为负责人 则显示按钮组
        var logusername = '@(Session["fullname"])';
        if (logusername == localStorage.getItem("ChargeEmpname")) {
            $("#btngroup").show();
        } else
        {
            $("#btngroup").hide();
        }

        $("#RepairId").html(localStorage.getItem("RepairId"));
        $("#ResponseContent").html(localStorage.getItem("ResponseContent") == "null" ? '' : localStorage.getItem("ResponseContent"));
        $("#SystemCategory").html(localStorage.getItem("SystemCategory"));
        $("#Building").html(localStorage.getItem("Building"));
        $("#Loaction").html(localStorage.getItem("Loaction"));
        $("#ChargeEmpname").html(localStorage.getItem("ChargeEmpname"));
        $("#RoomNum").html(localStorage.getItem("RoomNum"));
        $("#ResponseEmpname").html(localStorage.getItem("ResponseEmpname"));
        $("#Telephone").html(localStorage.getItem("Telephone"));
        $("#RepairTime").html(localStorage.getItem("RepairTime") == "null" ? '' : localStorage.getItem("RepairTime"));
        $("#Category").html(localStorage.getItem("Category"));
        $("#DamageReason").html(localStorage.getItem("DamageReason"));
        $("#DamageClass").html(localStorage.getItem("DamageClass"));
        $("#DamageName").html(localStorage.getItem("DamageName"));
        $("#CreatTime").html(formatDate(localStorage.getItem("CreatTime"), 'yyyy-MM-dd HH:mm:ss'));
        $("#ReplyContent").html(localStorage.getItem("ReplyContent") == "null" ? '' : localStorage.getItem("ReplyContent"));
        $("#FinishTime").html(localStorage.getItem("FinishTime") == "null" ? '' : formatDate(localStorage.getItem("CreatTime"), 'yyyy-MM-dd HH:mm:ss'));
        //localStorage.clear();

        form.on('submit(demo1)', function () {
            var model = {
                "NewReplyContent": $("#NewReplyContent").val(),
                "ReplyContent": $("#ReplyContent").val(),
                "Status": $("#OpStatus").val(),
                "RepairId": localStorage.getItem("RepairId"),
                "ChargeEmpname": localStorage.getItem("ChargeEmpname"),
                "ChargeEmpno": localStorage.getItem("ChargeEmpno"),
            };
            if ($("#OpStatus").val() == localStorage.getItem("Status"))
            {
                layer.open({
                    title: "确认状态",
                    type: 0,
                    btn: ["确定", "取消"],
                    area: ['320px', '200px'],
                    content: '<div>状态未做出更改，是否确定送出？</div>',
                    btn1: function () {
                        layer.closeAll();
                        $.ajax({
                            type: 'post',
                            url: "@(Url.Action("ReplyProblemSave", "Repair"))",
                            data: JSON.stringify(model),
                            async: false,
                            dataType: "json",
                            processData: false,
                            contentType: 'application/json',
                            beforeSend: function () {
                                $('#btn1').addClass("layui-btn-disabled").attr("disabled", true);
                            },
                            success: function (result) {
                                if (result.IsSuccess) {
                                    alert("送出成功");
                                    var url = "@(Url.Action("ReplyRepairIndex", "Repair"))";
                                    $("#content").load(url);
                                }
                                else {
                                    alert(result.Msg);
                                }
                            }
                        });
                    },
                    btn2: function () {
                        layer.closeAll();
                    }
                })
            } else{
                $.ajax({
                type: 'post',
                url: "@(Url.Action("ReplyProblemSave", "Repair"))",
                data: JSON.stringify(model),
                async: false,
                dataType: "json",
                processData: false,
                contentType: 'application/json',
                beforeSend: function () {
                    $('#btn_submit').addClass("layui-btn-disabled").attr("disabled", true);
                },
                success: function (result) {
                    if (result.IsSuccess) {
                        alert("送出成功");
                         var url = "@(Url.Action("ReplyRepairIndex", "Repair"))";
                        $("#content").load(url);
                    }
                    else {
                        alert(result.Msg);
                    }
                }

                });
            }

            return false;
        });

        function render() {
            // 封装函数-表单更新渲染
            layui.use('form', function () {
                var form = layui.form;
                form.render('select');
            })
        }

        $('#TransferProblem').click(function () {
            layer.open({
                title: '转派任务',
                area: ['40%', '35%'],
                content: $("#transferWindow"),
                shade: 0.0,
                type: 1,
                btn: ['确定', '重置'],
                btn1: function (index, layero) {
                    var formSubmit = $("#transferWindow");
                    var submited = formSubmit.find('button')[0];
                    submited.click();
                },
                btn2: function (index, layero) {
                    $('select[name=OpEmpNo]').val("");
                    $("#opinion").val("");
                    render();
                    return false;
                    loadoption();
                },
                cancel: function (layero, index) {
                    layer.closeAll();
                }
            });
        });
        
        $("#btn_back").on("click", function () {
             var url = "@(Url.Action("ProblemAllVw", "Repair"))";
             $("#content").load(url);
        });
    });
</script>

